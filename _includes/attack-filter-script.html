<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('attacks-table');
    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('th');
    
    // Store all rows initially
    const allRows = Array.from(tbody.querySelectorAll('tr'));

    const searchInput = document.getElementById('search-filter');
    const dataTypeFilter = document.getElementById('datatype-filter');
    const releaseTypeFilter = document.getElementById('release-filter');
    const objectiveFilter = document.getElementById('objective-filter');
    const researchTypeFilter = document.getElementById('researchtype-filter');
    const yearFilter = document.getElementById('year-filter');
    const clearButton = document.getElementById('clear-filters');
    const filtersButton = document.getElementById('filters-button');
    const filtersDropdown = document.getElementById('filters-dropdown');

    let sortColumn = -1;
    let sortDirection = 'asc';

    function filter() {
        console.log('Filtering...');
        const searchTerm = searchInput.value.toLowerCase();
        const dataType = dataTypeFilter.value;
        const releaseType = releaseTypeFilter.value;
        const objective = objectiveFilter.value;
        const researchType = researchTypeFilter.value;
        const year = yearFilter.value;

        allRows.forEach(row => {
            const title = row.cells[0].textContent.toLowerCase();
            const authors = row.cells[1].textContent.toLowerCase();
            const rowYear = row.cells[2].textContent;
            const rowDataType = row.cells[3].textContent;
            const rowReleaseType = row.cells[4].textContent;
            const rowObjective = row.cells[5].textContent;
            const rowResearchType = row.cells[6].textContent;

            const searchMatch = searchTerm === "" || title.includes(searchTerm) || authors.includes(searchTerm);
            const dataTypeMatch = dataType === "" || rowDataType === dataType;
            const releaseTypeMatch = releaseType === "" || rowReleaseType === releaseType;
            const objectiveMatch = objective === "" || rowObjective === objective;
            const researchTypeMatch = researchType === "" || rowResearchType === researchType;
            const yearMatch = year === "" || rowYear === year;

            if (searchMatch && dataTypeMatch && releaseTypeMatch && objectiveMatch && researchTypeMatch && yearMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    function populateFilters() {
        const dataTypes = new Set();
        const releaseTypes = new Set();
        const objectives = new Set();
        const researchTypes = new Set();
        const years = new Set();

        allRows.forEach(row => {
            dataTypes.add(row.cells[3].textContent.trim());
            releaseTypes.add(row.cells[4].textContent.trim());
            objectives.add(row.cells[5].textContent.trim());
            researchTypes.add(row.cells[6].textContent.trim());
            years.add(row.cells[2].textContent.trim());
        });

        populateSelect(dataTypeFilter, dataTypes, "Data Type (Inputs)");
        populateSelect(releaseTypeFilter, releaseTypes, "Type of Data Release (Outputs)");
        populateSelect(objectiveFilter, objectives, "Attacker Objectives");
        populateSelect(researchTypeFilter, researchTypes, "Research Type");
        populateSelect(yearFilter, years, "Year");
    }

    function populateSelect(selectElement, options, defaultText) {
        // Clear existing options
        selectElement.innerHTML = `<option value="">${defaultText}</option>`;
        
        const sortedOptions = Array.from(options).sort();

        for (const option of sortedOptions) {
            if (option) {
                selectElement.add(new Option(option, option));
            }
        }
    }
    
    function clearFilters() {
        searchInput.value = '';
        dataTypeFilter.value = '';
        releaseTypeFilter.value = '';
        objectiveFilter.value = '';
        researchTypeFilter.value = '';
        yearFilter.value = '';
        filter();
    }
    
    function toggleFilters() {
        filtersDropdown.style.display = filtersDropdown.style.display === 'none' ? '' : 'none';
    }
    
    function sortTable(columnIndex) {
        console.log(`Sorting by column ${columnIndex}`);
        if (sortColumn === columnIndex) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = columnIndex;
            sortDirection = 'asc';
        }
        
        // Sort allRows, not just visible ones
        allRows.sort((a, b) => {
            const aVal = a.cells[columnIndex].textContent.trim();
            const bVal = b.cells[columnIndex].textContent.trim();

            if (aVal < bVal) {
                return sortDirection === 'asc' ? -1 : 1;
            }
            if (aVal > bVal) {
                return sortDirection === 'asc' ? 1 : -1;
            }
            return 0;
        });

        // Re-append all rows to the tbody in the new sorted order
        tbody.innerHTML = ''; // Clear current tbody
        allRows.forEach(row => tbody.appendChild(row));
        
        // Re-apply filters after sorting
        filter();
    }

    console.log('Headers found:', headers);
    headers.forEach((header, index) => {
        console.log(`Attaching click listener to header ${index}`);
        header.addEventListener('click', () => {
            sortTable(index);
        });
    });


    searchInput.addEventListener('input', filter);
    dataTypeFilter.addEventListener('change', filter);
    releaseTypeFilter.addEventListener('change', filter);
    objectiveFilter.addEventListener('change', filter);
    researchTypeFilter.addEventListener('change', filter);
    yearFilter.addEventListener('change', filter);
    clearButton.addEventListener('click', clearFilters);
    filtersButton.addEventListener('click', toggleFilters);

    populateFilters();
    filter(); // Initial filter application
});
</script>